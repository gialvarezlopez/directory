{% extends 'web/base.html.twig' %}

{% block title_page %}
    MD || Find your medics
{% endblock %}

{% block classbg %}
    listing-with-map-page
{% endblock %} 

{% block content %}

<!-- Listings -->
<section id="ElemoListing_with_map">
	<div class="ElemoListing_map">
    	<div id="map-container">
		    <div id="map" data-map-zoom="9" data-map-scroll="true">
		        <!-- map goes here -->
		    </div>
		</div>
    </div>
	<div class="search_wrap">
    	<div class="search_form">
            <form action="" method="get">
                <div class="form-group" style="width: 25%;">
                    <div class="select">
                        <select class="form-control" id="state" name="state">                            
                            <option value="0">Select State</option>
                            {% for states in state %}                         
                               
                                    <option value="{{ states.staId }}">{{ states.staName }}</option>                               
                       
                            {% endfor %}

	                    </select>
                    </div>
                </div>
                <div class="form-group" style="width: 25%;" name="city">
                    <div class="select">
                        <select class="form-control" id="cities">

                            

                        </select>
                    </div>
                </div>
                <div class="form-group" style="width: 25%;">
                    <div class="select">
                        <select class="form-control" id="speciality" name="speciality">                            
                            <option value="0">Select State</option>
                            {% for spe in speciality %}                         
                               
                                    <option value="{{ spe.spId }}">{{ spe.spName }}</option>                               
                       
                            {% endfor %}

                        </select>
                    </div>
                </div>

                <div class="btn_group" style="width: 25%;">
                    <input type="submit" value="Search" class="btn btn-block">
                </div>
            </form>
        </div>
    </div>
    
	<div class="container">
    	<div class="listing_header">
        	<h5>Medical Profiles</h5>
            
            <div class="layout-switcher">
                <a href="#" class="active"><i class="fa fa-th"></i></a>
                <a href="listing-listview-map.html"><i class="fa fa-align-justify"></i></a>
            </div>
        </div>
        
        <div class="row">

            {% for m in medic %}

                <div class="col-md-6 col-lg-4 grid_col show_listingx">
                    <div class="items-list listing_wrap" data-marker-id="1">
                        <div class="listing_img" style="height: 300px;">
                            <span class="like_post"><i class="fa fa-bookmark-o"></i></span>
                            <!--
                            <div class="listing_cate">
                                <span class="cate_icon"><a href="#"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon5.png') }} " alt="icon-img"></a></span> 
                                <span class="listing_like"><a href="#"><i class="fa fa-heart-o"></i></a></span>
                            </div>
                            -->
                             {% set imgPerfil =  "uploads/" ~ m.md_profile_image %}
                            <a href="#"><img src="{{ asset(imgPerfil) }} " style="width: 100%;" alt="image"></a>
                        </div>
                        <div class="listing_info">
                            <!--
                            <div class="post_category">
                                <a href="#">{{ m.cit_name }} /{{ m.sta_code }} </a>
                            </div>-->
                            <h4><a href="#">{{ m.md_first_name }} {{ m.md_first_surname }}</a></h4>
                            
                            <p> {{ m.esp }} </p>
                             
                            <div class="listing_review_info">
                               
                                <p><span class="review_score"><i class="fa fa-eye"></i> {{ m.total }} </span> 
                                    <!--<i class="fa fa-star active"></i> <i class="fa fa-star active"></i> <i class="fa fa-star active"></i> 
                                   <i class="fa fa-star active"></i> <i class="fa fa-star"></i> 
                                   (5 Reviews)--> </p>
                                <p class="listing_map_m" id="{{ m.ci_lat}}" name="{{ m.ci_lng }}"><i class="fa fa-map-marker"></i> {{ m.cit_name }} /{{ m.sta_name }}</p>
                            </div>
                        </div>
                    </div>
                </div>

            {% endfor %}
	        
        </div>
        <nav class="pagination_nav">
            <div class="navigation text-center">
                {{ knp_pagination_render(medic) }}
            </div>
         
        </nav>
    </div>    
</section>
<!-- /Listings -->
{% endblock %}

{% block codejs %}
    <script>
              

        $(function(){
            $('#state').change(function(){

                var idSate = $(this).val();
                $("#cities").empty();
                $.ajax({
                    type: "post",
                    url: "{{ path('web_get_cities') }}",
                    data: {id: idSate },
                    error: function (data) {
                            alert('Error : Load Cities');
                            },
                    success: function (data) {
                        //var $this = $("#cities");
                        //console.log(data);
                        $("#cities").append("<option value='0'>Select City</option>");
                        $.each(data, function (key, value) {
                            $("#cities").append("<option value=" + value.cit_id + ">" + value.cit_name + "</option>");
                        });

                    }
                });

            });
        });
        //$(document).on("ready", function(){
        $(function () {
               
/*-------------------------------------------------------------------------------
		Googl-Map
	-------------------------------------------------------------------------------*/

    function GooglMap() {
        var ib = new InfoBox();
        var test = {{ medic.items|json_encode|raw }};

        $(document).ready(function(){
            $(".listing_map_m").click(function(){

                 listing_map_m($(this).attr('id'), $(this).attr('name') );
            });
               
            
        });

        function showMe(lat1, lng1) {
            

            var myLatlng = {lat: parseFloat(lat1), lng: parseFloat(lng1)};


              var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: myLatlng
              });

              var marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: 'Click to zoom'
              });

              map.addListener('center_changed', function() {
                // 3 seconds after the center of the map has changed, pan back to the
                // marker.
                window.setTimeout(function() {
                  map.panTo(marker.getPosition());
                }, 3000);
              });

              marker.addListener('click', function() {
                map.setZoom(8);
                map.setCenter(marker.getPosition());
              });
            console.log(lat1,lng1);
        }

        function listing_map_m(lat,lng){
            showMe(lat , lng);
        }

        function locationData(locationURL, locationImg, locationTitle, locationAddress, locationRating, locationRatingCounter) {
            return ('' + '<a href="' + locationURL + '" class="map-post-thumb-m">' + '<div class="map-popup-close"><i class="fa fa-times"></i></div>' + '<img src="' + locationImg + '" alt="">' + '</a>' + '<div class="map-post-des-m">'+ '<h5>' + '<a href="' + locationURL + '">' + locationTitle + '</a>' + '</h5>' + '<span><i class="fa fa-phone"></i> ' + locationAddress + '</span>' + '</div>' + '<div class="listing-content">' + '</div>')
        }
        var locations = [];

            $.each(test, function( k, v ) {                    

                locations.push([locationData('showProfile/'+v.usr_id, '{{ asset('uploads/') }}'+v.md_profile_image, v.md_first_name +' '+v.md_first_surname, v.ci_phone1, '5.0', '23'),v.ci_lat, v.ci_lng, 2, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/doctor.jpg') }} "></i>'])
                
            })
            
			/*
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'Laisa Spa Center', '41 Sunset Blvd, Lawton, OK 73505, USA', '5.0', '23'), 40.77055783505125, -74.26002502441406, 2, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon4.png') }} "></i>'],
			
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'Blue Women Parlour', '778 Sunset Blvd, Lawton, OK 73505, USA', '2.0', '17'), 40.7427837, -73.11445617675781, 3, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon4.png') }} "></i>'],
			
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'Auto Repair Shop', '2726 Shinn Street, New York', '5.0', '31'), 40.70437865245596, -73.98674011230469, 4, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon6.png') }} "></i>'],
			
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'Eating Restaurant', '1512 Duncan Avenue, New York', '3.5', '46'), 40.641311, -73.778139, 5, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon2.png') }}"></i>'],
			
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'The Shelby Apartment', '215 Terry Lane, New York', '4.5', '15'), 41.080938, -73.535957, 6, '<i class="im-icon"><img src=" {{ asset('bundles/web/template/Site/assets/images/category-icon1.png') }}  "></i>'],
			
            [locationData('listing-detail-1.html', '{{ asset('bundles/web/template/Site/assets/images/600x450.jpg') }} ', 'Fitness Center', '2726 Shinn Street, New York', '5.0', '31'), 41.079386, -73.519478, 7, '<i class="im-icon"><img src="{{ asset('bundles/web/template/Site/assets/images/category-icon3.png') }}"></i>'],*/
        
		
        var mapZoomAttr = $('#map').attr('data-map-zoom');
        if (typeof mapZoomAttr !== typeof undefined && mapZoomAttr !== false) {
            var zoomLevel = parseInt(mapZoomAttr);
        } else {
            var zoomLevel = 9;
        }
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: zoomLevel,
            scrollwheel: true,
			disableDefaultUI: true,
            center: new google.maps.LatLng(40.80, -73.70),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            zoomControl: false,
            mapTypeControl: false,
            scaleControl: false,
            panControl: false,
            navigationControl: false,
            streetViewControl: false,
        });
        $('.items-list').on('mouseover', function() {
            var listingAttr = $(this).data('post-id');
            if (listingAttr !== undefined) {
                var listing_id = $(this).data('post-id') - 1;
                var marker_div = allMarkers[listing_id].div;
                $(marker_div).addClass('clicked');
                $(this).on('mouseout', function() {
                    if ($(marker_div).is(":not(.infoBox-opened)")) {
                        $(marker_div).removeClass('clicked');
                    }
                });
            }
        });
        var boxText = document.createElement("div");
        boxText.className = 'map-box'
        var currentInfobox;
        var boxOptions = {
            content: boxText,
            disableAutoPan: false,
            alignBottom: true,
            maxWidth: 0,
            pixelOffset: new google.maps.Size(-134, -55),
            zIndex: null,
            boxStyle: {
                width: "290px"
            },
            closeBoxMargin: "0",
            closeBoxURL: "",
            infoBoxClearance: new google.maps.Size(25, 25),
            isHidden: false,
            pane: "floatPane",
            enableEventPropagation: false,
        };
        var markerCluster, overlay, i;
        var allMarkers = [];
        var clusterStyles = [{
            textColor: 'white',
            url: '',
            height: 50,
            width: 50
        }];
        var markerIco;
        for (i = 0; i < locations.length; i++) {
            markerIco = locations[i][4];
            var overlaypositions = new google.maps.LatLng(locations[i][1], locations[i][2]),
                overlay = new CustomMarker(overlaypositions, map, {
                    marker_id: i
                }, markerIco);
            allMarkers.push(overlay);
            google.maps.event.addDomListener(overlay, 'click', (function(overlay, i) {
                return function() {
                    ib.setOptions(boxOptions);
                    boxText.innerHTML = locations[i][0];
                    ib.open(map, overlay);
                    currentInfobox = locations[i][3];
                    google.maps.event.addListener(ib, 'domready', function() {
                        $('.map-popup-close').click(function(e) {
                            e.preventDefault();
                            ib.close();
                            $('.map-marker-container').removeClass('clicked infoBox-opened');
                        });
                    });
                }
            })(overlay, i));
        }
        var options = {
            imagePath: 'images/',
            styles: clusterStyles,
            minClusterSize: 2
        };
        markerCluster = new MarkerClusterer(map, allMarkers, options);
        google.maps.event.addDomListener(window, "resize", function() {
            var center = map.getCenter();
            google.maps.event.trigger(map, "resize");
            map.setCenter(center);
        });
        var zoomControlDiv = document.createElement('div');
        var zoomControl = new ZoomControl(zoomControlDiv, map);

        function ZoomControl(controlDiv, map) {
            zoomControlDiv.index = 1;
            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(zoomControlDiv);
            controlDiv.className = "leaflet-control-zoom";
            var controlWrapper = document.createElement('div');
            controlDiv.appendChild(controlWrapper);
            var zoomInButton = document.createElement('div');
            zoomInButton.className = "custom-zoom-in";
            controlWrapper.appendChild(zoomInButton);
            var zoomOutButton = document.createElement('div');
            zoomOutButton.className = "custom-zoom-out";
            controlWrapper.appendChild(zoomOutButton);
            google.maps.event.addDomListener(zoomInButton, 'click', function() {
                map.setZoom(map.getZoom() + 1);
            });
            google.maps.event.addDomListener(zoomOutButton, 'click', function() {
                map.setZoom(map.getZoom() - 1);
            });
        }
        $("#geoLocation, .input-with-icon.location a").click(function(e) {
            e.preventDefault();
            geolocate();
        });

        function geolocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setCenter(pos);
                    map.setZoom(12);
                });
            }
        }
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            map.setOptions({
                draggable: false
            });
        }
    }
	
	
	
    var map = document.getElementById('map');
    if (typeof(map) != 'undefined' && map != null) {
        google.maps.event.addDomListener(window, 'load', GooglMap);
        google.maps.event.addDomListener(window, 'resize', GooglMap);
    }

    function singlemap() {
        var myLatlng = new google.maps.LatLng({
            lng: $('#singlemap').data('longitude'),
            lat: $('#singlemap').data('latitude'),
        });
        var single_map = new google.maps.Map(document.getElementById('singlemap'), {
            zoom: 15,
            center: myLatlng,
            scrollwheel: false,
            zoomControl: false,
            mapTypeControl: false,
            scaleControl: false,
			fullscreenControl: false,
            panControl: false,
            navigationControl: false,
            streetViewControl: false,
        });
        var zoomControlDiv = document.createElement('div');
        var zoomControl = new ZoomControl(zoomControlDiv, single_map);

        function ZoomControl(controlDiv, single_map) {
            zoomControlDiv.index = 1;
            single_map.controls[google.maps.ControlPosition.RIGHT_TOP].push(zoomControlDiv);
            var controlWrapper = document.createElement('div');
            controlDiv.appendChild(controlWrapper);
            var zoomInButton = document.createElement('div');
            zoomInButton.className = "custom-zoom-in";
            controlWrapper.appendChild(zoomInButton);
            var zoomOutButton = document.createElement('div');
            zoomOutButton.className = "custom-zoom-out";
            controlWrapper.appendChild(zoomOutButton);
            google.maps.event.addDomListener(zoomInButton, 'click', function() {
                single_map.setZoom(single_map.getZoom() + 1);
            });
            google.maps.event.addDomListener(zoomOutButton, 'click', function() {
                single_map.setZoom(single_map.getZoom() - 1);
            });
        }
        var singleMapIco = "<i class='im-icon'><img src='" + $('#singlemap').data('map-icon') + "'></i>";
        new CustomMarker(myLatlng, single_map, {
            marker_id: '1'
        }, singleMapIco);
    }
    var single_map = document.getElementById('singlemap');
    if (typeof(single_map) != 'undefined' && single_map != null) {
        google.maps.event.addDomListener(window, 'load', singlemap);
        google.maps.event.addDomListener(window, 'resize', singlemap);
    }

    function CustomMarker(latlng, map, args, markerIco) {
        this.latlng = latlng;
        this.args = args;
        this.markerIco = markerIco;
        this.setMap(map);
    }
    CustomMarker.prototype = new google.maps.OverlayView();
    CustomMarker.prototype.draw = function() {
        var self = this;
        var div = this.div;
        if (!div) {
            div = this.div = document.createElement('div');
            div.className = 'map-marker-container';
            div.innerHTML = '<div class="marker-container">' + '<div class="marker-card">' + '<div class="front face">' + self.markerIco + '</div>' + self.markerIco + '</div>'  + '</div>' + '</div>'
            google.maps.event.addDomListener(div, "click", function(event) {
                $('.map-marker-container').removeClass('clicked infoBox-opened');
                google.maps.event.trigger(self, "click");
                $(this).addClass('clicked infoBox-opened');
            });
            if (typeof(self.args.marker_id) !== 'undefined') {
                div.dataset.marker_id = self.args.marker_id;
            }
            var panes = this.getPanes();
            panes.overlayImage.appendChild(div);
        }
        var point = this.getProjection().fromLatLngToDivPixel(this.latlng);
        if (point) {
            div.style.left = (point.x) + 'px';
            div.style.top = (point.y) + 'px';
        }
    };
    CustomMarker.prototype.remove = function() {
        if (this.div) {
            this.div.parentNode.removeChild(this.div);
            this.div = null;
            $(this).removeClass('clicked');
        }
    };
    CustomMarker.prototype.getPosition = function() {
        return this.latlng;
    }; 
        });   
    </script>
{% endblock %}        

